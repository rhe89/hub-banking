@page "/transactions/add"
@page "/transactions/add/{accountId}"

@using Banking.Providers
@using Banking.Services
@using Microsoft.AspNetCore.Components
@using Hub.Shared.DataContracts.Banking.Dto
@using Hub.Shared.DataContracts.Banking.SearchParameters

@inject ITransactionProvider _transactionProvider
@inject IAccountProvider _accountProvider;
@inject ITransactionService _transactionService
@inject IPreferenceService _preferenceService;
@inject IPreferenceProvider _preferenceProvider;

@inherits Base

<main class="container mt-3">
    <header class="row">
        <div class="col-sm-12">
            <h1 class="float-start">Add transaction</h1>
            <button class="btn btn-primary float-end" @onclick="GoBack">Back</button>
        </div>
    </header>

    <section class="card mt-5">
        <div class="card-body">
            <EditForm Model="@Transaction">
                <div class="row">
                    <div class="col-lg-2 col-sm-12 py-1">
                        <label>Account: </label>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        @if (Accounts != null)
                        {
                            <InputSelect
                                class="form-control"
                                id="account"
                                disabled="@(_working || AccountId != null)"
                                @bind-Value="Transaction.AccountId">
                                @foreach (var account in Accounts)
                                {
                                    <option value="@account.Id">@($"{account.Name} ({account.Bank})")</option>
                                }
                            </InputSelect>
                        }
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-lg-2 col-sm-12 py-1">
                        <label>
                            Transaction date:
                        </label>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        <InputDate
                            class="form-control"
                            id="transaction-date"
                            disabled="@_working"
                            @bind-Value="Transaction.TransactionDate"/>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-lg-2 col-sm-12 py-1">
                        <label>Description: </label>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        <InputText
                            class="form-control"
                            id="description"
                            disabled="@_working"
                            TValue="string"
                            @oninput="Callback"
                            @bind-Value="Transaction.Description"/>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-lg-2 col-sm-12">
                        <label>
                            Amount:
                        </label>
                    </div>
                    <div class="col-lg-6 col-sm-12">
                        <InputNumber
                            class="form-control"
                            id="amount"
                            disabled="@_working"
                            @bind-Value="Transaction.Amount"/>
                    </div>
                </div>
                
                @if (ValidationErrors.Any(x => !string.IsNullOrEmpty(x.Value)))
                {
                    <div class="row mt-3">
                        <div class="col-lg-8 col-sm-12">
                            @foreach (var validationError in ValidationErrors.Where(x => !string.IsNullOrEmpty(x.Value)))
                            {
                                <div class="alert alert-danger" role="alert">
                                    <p>@validationError.Value</p>
                                </div>
                            }
                            
                        </div>
                    </div>
                }
                

                <div class="row mt-3">
                    <div class="col-lg-5 col-sm-12 btn-group">
                        <button
                            class="btn btn-primary me-2"
                            disabled="@_working"
                            @onclick="SaveAndAddNewTransaction"
                            type="button">
                            Save and add new transaction
                        </button>
                        <button
                            class="btn btn-primary"
                            disabled="@_working"
                            @onclick="SaveAndGoBack"
                            type="button">
                            Save and go back
                        </button>
                    </div>
                </div>
            </EditForm>
        </div>
    </section>
    <section class="card mt-5">
        <div class="card-body table-container">
            <header class="row">
                <div class="col">
                    <h2 class="h3">@SimilarTransactionsHeader</h2>
                </div>
            </header>
            @if (SimilarTransactions.Any())
            {
                <table class="table table-borderless">
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th class="w-50-ellipsis">Description</th>
                        <th>Amount</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var transaction in SimilarTransactions)
                    {
                        <tr>
                            <td class="py-3">@transaction.TransactionDate.ToShortDateString()</td>
                            <td class="py-3 w-50-ellipsis">@transaction.Description</td>
                            <td class="py-3">@transaction.Amount</td>
                            <td>
                                <button
                                    class="btn btn-primary"
                                    disabled="@_working"
                                    @onclick="() => UseTransactionDetails(transaction)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                      <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            }
        </div>
    </section>
</main>

@code {
    [Parameter]
    public string AccountId { get; set; }
    
    private const int PreviousTransactionsAgeInMonths = 3;
    private const string AddTransactionPreselectedAccountPreference = "AddTransactionPreselectedAccount";
    private string SimilarTransactionsHeader { get; set; }

    private IDictionary<string, string> ValidationErrors { get; } = new Dictionary<string, string>()
    {
        { nameof(TransactionDto.Amount), "" },
        { nameof(TransactionDto.AccountId), "" },
        { nameof(TransactionDto.Description), "" },
        { nameof(TransactionDto.TransactionDate), "" },
    };
    private TransactionDto Transaction { get; set; } = new();
    private IList<AccountDto> Accounts { get; set; } = new List<AccountDto>();
    private IList<TransactionDto> PreviousTransactions { get; set; } = new List<TransactionDto>();
    private IList<TransactionDto> SimilarTransactions { get; set; } = new List<TransactionDto>();

    private bool _working;

    protected override async Task OnInitializedAsync()
    {
        _working = true;
        
        Accounts = await _accountProvider.GetAccounts(new AccountSearchParameters());
        PreviousTransactions = await _transactionProvider.GetTransactions(new TransactionSearchParameters { FromDate = DateTime.Now.AddMonths(-PreviousTransactionsAgeInMonths)});

        if (AccountId != null)
        {
            Transaction.AccountId = long.Parse(AccountId);
        }
        else
        {
            var previousSelectedAccounts = await _preferenceProvider.GetPreferences(AddTransactionPreselectedAccountPreference);

            if (previousSelectedAccounts.Any())
            {
                Transaction.AccountId = long.Parse(previousSelectedAccounts.First().Value);
            }
        }

        Transaction.Amount = 0;
        Transaction.TransactionDate = DateTime.Now;
        Transaction.TransactionType = 0;
        OnDescriptionChanged(Transaction.Description);
        
        _working = false;
    }

    private void UseTransactionDetails(TransactionDto transaction)
    {
        Transaction.Amount = transaction.Amount;
        Transaction.AccountId = transaction.AccountId;
        Transaction.Description = transaction.Description.ToUpper().Replace(" ", "_");
        Transaction.TransactionType = transaction.TransactionType;
        Transaction.TransactionDate = transaction.TransactionDate.AddMonths(1);
        
        Validate(out _);
        
        OnDescriptionChanged(Transaction.Description);
    }
    
    private void OnDescriptionChanged(string description)
    {
        _working = true;

        Transaction.Description = description;

        if (string.IsNullOrEmpty(Transaction.Description))
        {
            SimilarTransactionsHeader = $"Previous transactions last {PreviousTransactionsAgeInMonths} months";
            SimilarTransactions = PreviousTransactions;
        }
        else
        {
            SimilarTransactionsHeader = $"Similar transactions to '{Transaction.Description}' last {PreviousTransactionsAgeInMonths} months";
            SimilarTransactions = PreviousTransactions.Where(previousTransaction => previousTransaction.Description.Trim().ToLowerInvariant().Contains(Transaction.Description.Trim().ToLowerInvariant())).ToList();
        }

        if (!SimilarTransactions.Any())
        {
            SimilarTransactionsHeader = $"No similar transactions to '{Transaction.Description}'. Showing previous transactions last {PreviousTransactionsAgeInMonths} months";
            SimilarTransactions = PreviousTransactions;
        }
        
        _working = false;
    }

    private async Task SaveAndAddNewTransaction()
    {
        Validate(out var isValid);
        
        if (!isValid)
        {
            return;
        }
        
        await Save();


        Transaction = new TransactionDto
        {
            AccountId = Transaction.AccountId,
            TransactionDate = DateTime.Now,
            TransactionType = 0
        };
        
        PreviousTransactions = await _transactionProvider.GetTransactions(new TransactionSearchParameters { FromDate = DateTime.Now.AddMonths(-PreviousTransactionsAgeInMonths)});
        SimilarTransactionsHeader = $"Previous transactions last {PreviousTransactionsAgeInMonths} months";
        SimilarTransactions = PreviousTransactions;
    }

    private void Validate(out bool isValid)
    {
        isValid = true;
        
        if (string.IsNullOrEmpty(Transaction.Description))
        {
            ValidationErrors[nameof(TransactionDto.Description)] = "Missing description";
            isValid = false;
        }
        else
        {
            ValidationErrors[nameof(TransactionDto.Description)] = "";
        }
        
        if (Transaction.AccountId <= 0)
        {
            ValidationErrors[nameof(TransactionDto.AccountId)] = "Missing account";
            isValid = false;
        }
        else
        {
            ValidationErrors[nameof(TransactionDto.AccountId)] = "";
        }
        
        if (Transaction.Amount == 0)
        {
            ValidationErrors[nameof(TransactionDto.Amount)] = "Missing amount";
            isValid = false;
        }
        else
        {
            ValidationErrors[nameof(TransactionDto.Amount)] = "";
        }
        
        if (Transaction.TransactionDate == DateTime.MinValue)
        {
            ValidationErrors[nameof(TransactionDto.TransactionDate)] = "Missing transaction date";
            isValid = false;
        }
        else
        {
            ValidationErrors[nameof(TransactionDto.TransactionDate)] = "";
        }
    }

    private async Task SaveAndGoBack()
    {
        await Save();

        NavigationManager.NavigateTo("transactions");
    }
    
    private async Task Save()
    {
        _working = true;

        await _preferenceService.AddOrReplacePreference(AddTransactionPreselectedAccountPreference, Transaction.AccountId.ToString());

        Transaction.TransactionId = $"{Transaction.AccountId}-{Transaction.TransactionDate}-{Transaction.Description}-{Transaction.Amount}";
        
        await _transactionService.AddTransaction(Transaction);
        
        _working = false;
    }

    private void Callback(ChangeEventArgs obj)
    {
        if (obj?.Value is not string value)
        {
            return;
        }

        Transaction.Description = value.ToUpper().Replace(" ", "_");
        
        OnDescriptionChanged(Transaction.Description);
    }

}